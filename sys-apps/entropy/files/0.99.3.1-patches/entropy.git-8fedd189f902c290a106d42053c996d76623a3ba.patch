From 8fedd189f902c290a106d42053c996d76623a3ba Mon Sep 17 00:00:00 2001
From: Fabio Erculiani <lxnay@sabayonlinux.org>
Date: Fri, 2 Oct 2009 19:16:47 +0200
Subject: [PATCH] [entropy.client.interfaces.dep] also pull in packages which version number matches the one installed but have been repackaged in reality

---
 libraries/entropy/client/interfaces/dep.py |   28 ++++++++++++++++++++++++----
 1 files changed, 24 insertions(+), 4 deletions(-)

diff --git a/libraries/entropy/client/interfaces/dep.py b/libraries/entropy/client/interfaces/dep.py
index 064b12e..c0d26cd 100644
--- a/libraries/entropy/client/interfaces/dep.py
+++ b/libraries/entropy/client/interfaces/dep.py
@@ -524,6 +524,8 @@ class CalculatorsMixin:
         open_repo = self.open_repository
         intf_error = self.dbapi2.InterfaceError
         cdb_getversioning = self.clientDbconn.getVersioningData
+        cdb_retrieveBranch = self.clientDbconn.retrieveBranch
+        cdb_retrieveDigest = self.clientDbconn.retrieveDigest
         etp_cmp = self.entropyTools.entropy_compare_versions
         etp_get_rev = self.entropyTools.dep_get_entropy_revision
 
@@ -577,7 +579,10 @@ class CalculatorsMixin:
             dbconn = open_repo(r_repo)
             try:
                 repo_pkgver, repo_pkgtag, repo_pkgrev = dbconn.getVersioningData(r_id)
-            except (intf_error,TypeError,):
+                # note: read rationale below
+                repo_branch = dbconn.retrieveBranch(r_id)
+                repo_digest = dbconn.retrieveDigest(r_id)
+            except (intf_error, TypeError,):
                 # package entry is broken
                 const_debug_write(__name__,
                     "get_unsatisfied_dependencies repository entry broken for match => %s" % (
@@ -589,11 +594,17 @@ class CalculatorsMixin:
             for c_id in c_ids:
                 try:
                     installedVer, installedTag, installedRev = cdb_getversioning(c_id)
+                    # note: read rationale below
+                    installedBranch = cdb_retrieveBranch(c_id)
+                    installedDigest = cdb_retrieveDigest(c_id)
                 except TypeError: # corrupted entry?
                     installedVer = "0"
                     installedTag = ''
                     installedRev = 0
-                client_data.add((installedVer, installedTag, installedRev,))
+                    installedBranch = None
+                    installedDigest = None
+                client_data.add((installedVer, installedTag, installedRev,
+                    installedBranch, installedDigest,))
 
             # support for app-foo/foo-123~-1
             # -1 revision means, always pull the latest
@@ -605,16 +616,25 @@ class CalculatorsMixin:
 
             # this is required for multi-slotted packages (like python)
             # and when people mix Entropy and Portage
-            for installedVer, installedTag, installedRev in client_data:
+            for installedVer, installedTag, installedRev, cbranch, cdigest in client_data:
+
                 vcmp = etp_cmp((repo_pkgver,repo_pkgtag,repo_pkgrev,),
                     (installedVer,installedTag,installedRev,))
-                if vcmp == 0:
+
+                # check if both pkgs share the same branch and digest, this must
+                # be done to avoid system inconsistencies across branch upgrades
+                if (vcmp == 0) and (cbranch != repo_branch) and \
+                    (cdigest != repo_digest):
+                    vcmp = 1
+
+                if (vcmp == 0):
                     const_debug_write(__name__,
                         "get_unsatisfied_dependencies SATISFIED equals (not cached, deep: %s) => %s" % (
                             deep_deps, dependency,))
                     depcache[dependency] = 0
                     const_debug_write(__name__, "...")
                     return 0
+
                 ver_tag_repo = (repo_pkgver, repo_pkgtag,)
                 ver_tag_inst = (installedVer, installedTag,)
                 rev_match = repo_pkgrev != installedRev
-- 
1.6.3.3

