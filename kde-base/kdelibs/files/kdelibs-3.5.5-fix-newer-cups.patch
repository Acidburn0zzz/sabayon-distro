--- kdelibs-3.5.5.orig/kdeprint/cups/kmcupsmanager.h
+++ kdelibs-3.5.5/kdeprint/cups/kmcupsmanager.h
@@ -25,10 +25,7 @@
 class IppRequest;
 class KLibrary;
 class KExtendedSocket;
-
-namespace KNetwork {
-    class KStreamSocket;
-}
+class QSocket;
 
 class KMCupsManager : public KMManager
 {
@@ -98,7 +95,7 @@
 private:
 	KLibrary	*m_cupsdconf;
 	KMPrinter	*m_currentprinter;
-        KNetwork::KStreamSocket   *m_socket;
+	QSocket *m_socket;
 	bool m_hostSuccess;
 	bool m_lookupDone;
 };
--- kdelibs-3.5.5.orig/kdeprint/cups/kmcupsuimanager.cpp
+++ kdelibs-3.5.5/kdeprint/cups/kmcupsuimanager.cpp
@@ -135,7 +135,7 @@
 	QString		uri;
 
 	req.setOperation(CUPS_GET_DEVICES);
-	uri = QString::fromLocal8Bit("ipp://%1/printers/").arg(CupsInfos::self()->hostaddr());
+	uri = QString::fromLocal8Bit("ipp://%1:%2/printers/").arg(CupsInfos::self()->host()).arg(CupsInfos::self()->port());
 	req.addURI(IPP_TAG_OPERATION,"printer-uri",uri);
 
 	if (req.doRequest("/"))
--- kdelibs-3.5.5.orig/kdeprint/cups/kmcupsmanager.cpp
+++ kdelibs-3.5.5/kdeprint/cups/kmcupsmanager.cpp
@@ -45,14 +45,12 @@
 #include <klocale.h>
 #include <kconfig.h>
 #include <kstandarddirs.h>
-#include <ksocketbase.h>
 #include <klibloader.h>
 #include <kmessagebox.h>
 #include <kaction.h>
 #include <kdialogbase.h>
 #include <kextendedsocket.h>
 #include <kprocess.h>
-#include <kbufferedsocket.h>
 #include <kfilterdev.h>
 #include <cups/cups.h>
 #include <cups/ppd.h>
@@ -90,7 +88,7 @@
 
 KMCupsManager::~KMCupsManager()
 {
-	delete m_socket;
+	//delete m_socket;
 }
 
 QString KMCupsManager::driverDbCreationProgram()
@@ -137,8 +135,7 @@
 	{
 		req.setOperation(CUPS_ADD_CLASS);
 		QStringList	members = p->members(), uris;
-		QString		s;
-                s = QString::fromLocal8Bit("ipp://%1/printers/").arg(CupsInfos::self()->hostaddr());
+		QString		s = QString::fromLocal8Bit("ipp://%1:%2/printers/").arg(CupsInfos::self()->host()).arg(CupsInfos::self()->port());
 		for (QStringList::ConstIterator it=members.begin(); it!=members.end(); ++it)
 			uris.append(s+(*it));
 		req.addURI(IPP_TAG_PRINTER,"member-uris",uris);
@@ -910,23 +907,25 @@
 
 QString KMCupsManager::stateInformation()
 {
-	return QString("%1: %2")
+	return QString("%1: %2:%3")
 		.arg(i18n("Server"))
-		.arg(CupsInfos::self()->hostaddr());
+		.arg(CupsInfos::self()->host())
+		.arg(CupsInfos::self()->port());
 }
 
 void KMCupsManager::checkUpdatePossibleInternal()
 {
 	kdDebug(500) << "Checking for update possible" << endl;
 	delete m_socket;
-        m_socket = new KNetwork::KBufferedSocket;
-	m_socket->setTimeout( 1 );
-	connect( m_socket, SIGNAL( connected(const KResolverEntry&) ), 
-                SLOT( slotConnectionSuccess() ) );
-	connect( m_socket, SIGNAL( gotError( int ) ), SLOT( slotConnectionFailed( int ) ) );
-
-        trials = 5;
-        QTimer::singleShot( 1, this, SLOT( slotAsyncConnect() ) );
+	/*m_socket = new KExtendedSocket( CupsInfos::self()->host(), CupsInfos::self()->port() );
+	connect( m_socket, SIGNAL( connectionSuccess() ), SLOT( slotConnectionSuccess() ) );
+	connect( m_socket, SIGNAL( connectionFailed( int ) ), SLOT( slotConnectionFailed( int ) ) );
+	m_socket->setTimeout( 1 );*/
+	m_socket = new QSocket( this );
+	connect( m_socket, SIGNAL( connected() ), SLOT( slotConnectionSuccess() ) );
+	connect( m_socket, SIGNAL( error( int ) ), SLOT( slotConnectionFailed( int ) ) );
+	trials = 5;
+	QTimer::singleShot( 1, this, SLOT( slotAsyncConnect() ) );
 }
 
 void KMCupsManager::slotConnectionSuccess()
@@ -960,10 +959,7 @@
 {
 	kdDebug(500) << "Starting async connect" << endl;
 	//m_socket->startAsyncConnect();
-        if (CupsInfos::self()->host().startsWith("/"))
-            m_socket->connect( QString(), CupsInfos::self()->host());
-        else
-            m_socket->connectToHost( CupsInfos::self()->host(), CupsInfos::self()->port() );
+	m_socket->connectToHost( CupsInfos::self()->host(), CupsInfos::self()->port() );
 }
 
 void KMCupsManager::slotConnectionFailed( int errcode )
@@ -979,25 +975,9 @@
 		return;
 	}
 
-    QString einfo;
-
-    switch (errcode) {
-    case KNetwork::KSocketBase::ConnectionRefused:
-    case KNetwork::KSocketBase::ConnectionTimedOut:
-        einfo = i18n("connection refused") + QString(" (%1)").arg(errcode);
-        break;
-    case KNetwork::KSocketBase::LookupFailure:
-        einfo = i18n("host not found") + QString(" (%1)").arg(errcode);
-        break;
-    case KNetwork::KSocketBase::WouldBlock:
-    default:
-        einfo = i18n("read failed (%1)").arg(errcode);
-        break;
-    }
-
-    setErrorMsg( i18n( "Connection to CUPS server failed. Check that the CUPS server is correctly installed and running. "
-                "Error: %2: %1." ).arg( einfo, CupsInfos::self()->host()));
-    setUpdatePossible( false );
+	setErrorMsg( i18n( "Connection to CUPS server failed. Check that the CUPS server is correctly installed and running. "
+				"Error: %1." ).arg( errcode == QSocket::ErrConnectionRefused ? i18n( "connection refused" ) : i18n( "host not found" ) ) );
+	setUpdatePossible( false );
 }
 
 void KMCupsManager::hostPingSlot() {
@@ -1034,7 +1014,7 @@
 	if (use && !p->uri().isEmpty())
 		uri = p->uri().prettyURL();
 	else
-		uri = QString("ipp://%1/%3/%2").arg(CupsInfos::self()->hostaddr()).arg(p->printerName()).arg((p->isClass(false) ? "classes" : "printers"));
+		uri = QString("ipp://%1:%2/%4/%3").arg(CupsInfos::self()->host()).arg(CupsInfos::self()->port()).arg(p->printerName()).arg((p->isClass(false) ? "classes" : "printers"));
 	return uri;
 }
 
--- kdelibs-3.5.5.orig/kdeprint/cups/cupsdoprint.c
+++ kdelibs-3.5.5/kdeprint/cups/cupsdoprint.c
@@ -41,7 +41,7 @@
 #endif
 
 /* utility functions */
-static void error(const char* msg)
+void error(const char* msg)
 {
 	fprintf(stderr, "%s\n", msg);
 #if USE_LOG
@@ -50,7 +50,7 @@
 	exit(-1);
 }
 
-static void usage()
+void usage()
 {
 	error("usage: cupsdoprint [-H host[:port]][-P dest][-J name][-o opt=value[,...]][-U login[:password]] files...");
 }
@@ -81,7 +81,7 @@
    return result;
 }
 
-static const char* getPasswordCB(const char* prompt)
+const char* getPasswordCB(const char* prompt)
 {
 	char buf[ 256 ] = {0}, *c;
 	char *_user = shell_quote( cupsUser() ), *_passwd = NULL;
--- kdeprint/kdeprintrc.old     2006-11-09 16:58:33.000000000 +0100
+++ kdeprint/kdeprintrc 2006-11-09 16:58:48.000000000 +0100
@@ -4,3 +4,6 @@
 ViewToolBar=false
 ViewMenuBar=true
 ViewPrinterInfos=true
+
+[CUPS]
+Host=localhost

