diff -Nurp rtl8187_linuxdrv_V1.1.orig/ieee80211/ieee80211_softmac.c rtl8187_linuxdrv_V1.1/ieee80211/ieee80211_softmac.c
--- rtl8187_linuxdrv_V1.1.orig/ieee80211/ieee80211_softmac.c	2005-11-21 20:28:26.000000000 +0000
+++ rtl8187_linuxdrv_V1.1/ieee80211/ieee80211_softmac.c	2007-02-08 10:31:26.000000000 +0000
@@ -2165,14 +2165,22 @@ void ieee80211_softmac_init(struct ieee8
 #else	
 	ieee->wq = create_workqueue(DRV_NAME);
 #endif
-	
+
+#if LINUX_VERSION_CODE < KERNEL_VERSION(2,6,20)	
 	INIT_WORK(&ieee->start_ibss_wq,(void(*)(void*)) ieee80211_start_ibss_wq,ieee);
 	INIT_WORK(&ieee->associate_retry_wq,(void(*)(void*)) ieee80211_associate_retry_wq,ieee);
 	INIT_WORK(&ieee->associate_complete_wq,(void(*)(void*)) ieee80211_associate_complete_wq,ieee);
 	INIT_WORK(&ieee->associate_procedure_wq,(void(*)(void*)) ieee80211_associate_procedure_wq,ieee);
 	INIT_WORK(&ieee->softmac_scan_wq,(void(*)(void*)) ieee80211_softmac_scan_wq,ieee);
 	INIT_WORK(&ieee->wx_sync_scan_wq,(void(*)(void*)) ieee80211_wx_sync_scan_wq,ieee);
-	
+#else
+	INIT_WORK(&ieee->start_ibss_wq,ieee);
+	INIT_WORK(&ieee->associate_retry_wq,ieee);
+	INIT_WORK(&ieee->associate_complete_wq,ieee);
+	INIT_WORK(&ieee->associate_procedure_wq,ieee);
+	INIT_WORK(&ieee->softmac_scan_wq,ieee);
+	INIT_WORK(&ieee->wx_sync_scan_wq,ieee);
+#endif	
 	sema_init(&ieee->wx_sem, 1);
 	sema_init(&ieee->scan_sem, 1);
 	
diff -Nurp rtl8187_linuxdrv_V1.1.orig/ieee80211/crypto_compat.c rtl8187_linuxdrv_V1.1/ieee80211/crypto_compat.c
--- rtl8187_linuxdrv_V1.1.orig/ieee80211/crypto_compat.c	1970-01-01 00:00:00.000000000 +0000
+++ rtl8187_linuxdrv_V1.1/ieee80211/crypto_compat.c	2007-02-08 23:00:54.000000000 +0000
@@ -0,0 +1,33 @@
+#include <linux/kernel.h>
+#include <linux/scatterlist.h>
+#include <linux/crypto.h>
+ 
+void crypto_digest_init(struct crypto_tfm *tfm)
+{
+	struct crypto_hash *hash = crypto_hash_cast(tfm);
+	struct hash_desc desc = { .tfm = hash, .flags = tfm->crt_flags };
+
+	crypto_hash_init(&desc);
+}
+
+void crypto_digest_update(struct crypto_tfm *tfm,
+			  struct scatterlist *sg, unsigned int nsg)
+{
+	struct crypto_hash *hash = crypto_hash_cast(tfm);
+	struct hash_desc desc = { .tfm = hash, .flags = tfm->crt_flags };
+	unsigned int nbytes = 0;
+	unsigned int i;
+
+	for (i = 0; i < nsg; i++)
+		nbytes += sg[i].length;
+
+	crypto_hash_update(&desc, sg, nbytes);
+}
+
+void crypto_digest_final(struct crypto_tfm *tfm, u8 *out)
+{
+	struct crypto_hash *hash = crypto_hash_cast(tfm);
+	struct hash_desc desc = { .tfm = hash, .flags = tfm->crt_flags };
+
+	crypto_hash_final(&desc, out);
+}
diff -Nurp rtl8187_linuxdrv_V1.1.orig/ieee80211/crypto_compat.h rtl8187_linuxdrv_V1.1/ieee80211/crypto_compat.h
--- rtl8187_linuxdrv_V1.1.orig/ieee80211/crypto_compat.h	1970-01-01 00:00:00.000000000 +0000
+++ rtl8187_linuxdrv_V1.1/ieee80211/crypto_compat.h	2007-02-08 23:00:54.000000000 +0000
@@ -0,0 +1,17 @@
+#ifndef __CRYPTO_COMPAT_H 
+#define __CRYPTO_COMPAT_H 1
+
+void crypto_digest_init(struct crypto_tfm *tfm) __deprecated_for_modules;
+void crypto_digest_update(struct crypto_tfm *tfm,
+			  struct scatterlist *sg, unsigned int nsg);
+void crypto_digest_final(struct crypto_tfm *tfm, u8 *out);
+
+static int crypto_digest_setkey(struct crypto_tfm *tfm, const u8 *key,
+				unsigned int keylen);
+static inline int crypto_digest_setkey(struct crypto_tfm *tfm,
+                                       const u8 *key, unsigned int keylen)
+{
+	return tfm->crt_hash.setkey(crypto_hash_cast(tfm), key, keylen);
+}
+
+#endif
diff -Nurp rtl8187_linuxdrv_V1.1.orig/ieee80211/ieee80211_crypt_ccmp.c rtl8187_linuxdrv_V1.1/ieee80211/ieee80211_crypt_ccmp.c
--- rtl8187_linuxdrv_V1.1.orig/ieee80211/ieee80211_crypt_ccmp.c	2007-02-08 22:58:50.000000000 +0000
+++ rtl8187_linuxdrv_V1.1/ieee80211/ieee80211_crypt_ccmp.c	2007-02-08 23:00:02.000000000 +0000
@@ -23,6 +23,7 @@
 #include <linux/netdevice.h>
 #include <linux/if_ether.h>
 #include <linux/if_arp.h>
+#include <linux/mm.h>
 #include <asm/string.h>
 #include <linux/wireless.h>
 
diff -Nurp rtl8187_linuxdrv_V1.1.orig/ieee80211/ieee80211_crypt_tkip.c rtl8187_linuxdrv_V1.1/ieee80211/ieee80211_crypt_tkip.c
--- rtl8187_linuxdrv_V1.1.orig/ieee80211/ieee80211_crypt_tkip.c	2007-02-08 22:58:50.000000000 +0000
+++ rtl8187_linuxdrv_V1.1/ieee80211/ieee80211_crypt_tkip.c	2007-02-08 23:14:04.000000000 +0000
@@ -23,6 +23,7 @@
 #include <linux/netdevice.h>
 #include <linux/if_ether.h>
 #include <linux/if_arp.h>
+#include <linux/mm.h>
 #include <asm/string.h>
 
 #include "ieee80211.h"
@@ -32,6 +33,8 @@
 #include <asm/scatterlist.h>
 #include <linux/crc32.h>
 
+#include "crypto_compat.h"
+
 MODULE_AUTHOR("Jouni Malinen");
 MODULE_DESCRIPTION("Host AP crypt: TKIP");
 MODULE_LICENSE("GPL");
@@ -694,19 +697,3 @@ static struct ieee80211_crypto_ops ieee8
 	.extra_postfix_len	= 8 + 4, /* MIC + ICV */
 	.owner		        = THIS_MODULE,
 };
-
-
-static int __init ieee80211_crypto_tkip_init(void)
-{
-	return ieee80211_register_crypto_ops(&ieee80211_crypt_tkip);
-}
-
-
-static void __exit ieee80211_crypto_tkip_exit(void)
-{
-	ieee80211_unregister_crypto_ops(&ieee80211_crypt_tkip);
-}
-
-
-module_init(ieee80211_crypto_tkip_init);
-module_exit(ieee80211_crypto_tkip_exit);
diff -Nurp rtl8187_linuxdrv_V1.1.orig/ieee80211/ieee80211_crypt_wep.c rtl8187_linuxdrv_V1.1/ieee80211/ieee80211_crypt_wep.c
--- rtl8187_linuxdrv_V1.1.orig/ieee80211/ieee80211_crypt_wep.c	2007-02-08 22:58:50.000000000 +0000
+++ rtl8187_linuxdrv_V1.1/ieee80211/ieee80211_crypt_wep.c	2007-02-08 22:59:53.000000000 +0000
@@ -20,6 +20,7 @@
 #include <linux/slab.h>
 #include <linux/random.h>
 #include <linux/skbuff.h>
+#include <linux/mm.h>
 #include <asm/string.h>
 
 #include "ieee80211.h"
diff -Nurp rtl8187_linuxdrv_V1.1.orig/ieee80211/Makefile rtl8187_linuxdrv_V1.1/ieee80211/Makefile
--- rtl8187_linuxdrv_V1.1.orig/ieee80211/Makefile	2007-02-08 22:58:50.000000000 +0000
+++ rtl8187_linuxdrv_V1.1/ieee80211/Makefile	2007-02-08 23:02:54.000000000 +0000
@@ -1,7 +1,7 @@
 EXTRA_CFLAGS += -I$(TOPDIR)/drivers/net/wireless
 EXTRA_CFLAGS += -O2
 
-ieee80211-rtl-objs := ieee80211_softmac.o ieee80211_rx.o ieee80211_tx.o ieee80211_wx.o ieee80211_module.o ieee80211_softmac_wx.o
+ieee80211-rtl-objs := ieee80211_softmac.o ieee80211_rx.o ieee80211_tx.o ieee80211_wx.o ieee80211_module.o ieee80211_softmac_wx.o crypto_compat.o
 
 ieee80211_crypt-rtl-objs := ieee80211_crypt.o
 ieee80211_crypt_tkip-rtl-objs := ieee80211_crypt_tkip.o
