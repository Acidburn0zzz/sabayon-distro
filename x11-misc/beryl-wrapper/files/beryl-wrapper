#!/bin/sh
cmd=0
if [ -z "$1" ]; then
  cmd=1
else
  if [ "$1" = "e16" ]; then
    cmd=0
  elif [ "$1" = "fluxbox" ]; then
    cmd=0
  elif [ "$1" = "gnome" ]; then
    cmd=0
  else
    cmd=1
  fi
fi

processes=$(ps auxf)

acceleration_enabled=$(glxinfo | grep "direct rendering" | grep -i "yes")
if [ -n "$acceleration_enabled" ]; then
  if [ "$cmd" = "1" ]; then
    xgl_running=$(echo $processes | grep Xgl)
    if [ -n "$xgl_running" ]; then
      emerald --replace & beryl-xgl --replace dbus settings
    else
      emerald --replace & beryl --strict-binding --indirect-rendering --replace dbus settings
    fi
  fi
else
   # Notify the funny thing
   exec_cmd="dcop knotify default notify DRI_status Direct Rendering 'OpenGL acceleration is disabled. 3D Desktop cannot be loaded.' '' '' 2 0"
   echo $exec_cmd | /bin/bash
fi
